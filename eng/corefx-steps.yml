parameters:
  name: ''
  queue: {}

  # valid targetOS values:
  #   - Windows_NT
  #   - Linux
  #   - MacOS
  targetOS: ''
  framework: ''
  submitToHelix: true
  # should be separated by ;
  helixTargetQueues: ''
  testOuterloop: false
  skipTests: true
  runtimeOS: ''

phases:
  - template: /eng/common/templates/phases/base.yml
    parameters:
      variables:
        _targetOSParam: /p:TargetOS=${{ parameters.targetOS }}
        
        ${{ if eq(parameters.targetOS, 'Windows_NT') }}:
          _buildScript: build.cmd
          _msbuildCommand: powershell -ExecutionPolicy ByPass -NoProfile eng\common\msbuild.ps1 -warnaserror:0
          _buildCommonArgs: -ci
        ${{ if ne(parameters.targetOS, 'Windows_NT') }}:
          _buildScript: ./build.sh
          _msbuildCommand: ./eng/common/msbuild.sh --warnaserror false
          _buildCommonArgs: --ci

        ${{ if eq(parameters.runtimeOS, '') }}:
          _runtimeOSParam: ''
        ${{ if ne(parameters.runtimeOS, '') }}:
          _runtimeOSParam: /p:RuntimeOS=${{ parameters.runtimeOS }}

        ${{ if eq(parameters.submitToHelix, 'true') }}:
          _helixToken: $(BotAccount-dotnet-github-anon-kaonashi-bot-helix-token)
          _sendToHelixArgs: eng/sendtohelix.proj
                            /t:test 
                            /p:HelixAccessToken=$(_helixToken)
                            /p:HelixTargetQueues=${{ parameters.helixTargetQueues }}
                            $(_targetOSParam)

      name: ${{ parameters.name }}
      queue:
        parallel: 99
        ${{ insert }}: ${{ parameters.queue }}
      steps:
        - script: $(_buildScript)
                  $(_buildCommonArgs)
                  -includetests
                  -framework $(_targetGroup)
                  $(_runtimeOSParam)
                  /p:ArchGroup=$(_archGroup)
                  /p:ConfigurationGroup=$(_configuration)
                  /p:SkipTests=${{ parameters.skipTests }}
          displayName: Build Sources and Tests
        - ${{ if eq(parameters.submitToHelix, 'true') }}:
            - script: $(_msbuildCommand)
                      src\upload-tests.proj
                      /t:CompressRuntimeDir
                      /p:ArchGroup=$(_archGroup)
                      /p:ConfigurationGroup=$(_configuration)
                      $(_targetOSParam)
              displayName: Compress Runtime Directory
            - script: $(_msbuildCommand)
                      $(_sendToHelixArgs)
              displayName: Send to Helix